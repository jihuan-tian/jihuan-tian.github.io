<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Migrated project work journals to org-roam root directory | 止于至善</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Migrated project work journals to org-roam root directory" />
<meta name="author" content="Jihuan Tian" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="org-roam does not support Org files scattered in different folders which do not share a common ancestor. Therefore, I have to migrate my project work journals to the org-roam root directory. Since I still prefer to store project resources including figures, illustrations, scanned documents, mindmaps etc. into the project’s own folder, all the relative links to these resources in the work journals should be converted with respect to the org-roam root directory." />
<meta property="og:description" content="org-roam does not support Org files scattered in different folders which do not share a common ancestor. Therefore, I have to migrate my project work journals to the org-roam root directory. Since I still prefer to store project resources including figures, illustrations, scanned documents, mindmaps etc. into the project’s own folder, all the relative links to these resources in the work journals should be converted with respect to the org-roam root directory." />
<link rel="canonical" href="https://jihuan-tian.github.io/computer/2024/07/19/migrated-project-work-journals-to-org-roam-root-directory.html" />
<meta property="og:url" content="https://jihuan-tian.github.io/computer/2024/07/19/migrated-project-work-journals-to-org-roam-root-directory.html" />
<meta property="og:site_name" content="止于至善" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-07-19T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Migrated project work journals to org-roam root directory" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jihuan Tian"},"dateModified":"2024-07-19T00:00:00+08:00","datePublished":"2024-07-19T00:00:00+08:00","description":"org-roam does not support Org files scattered in different folders which do not share a common ancestor. Therefore, I have to migrate my project work journals to the org-roam root directory. Since I still prefer to store project resources including figures, illustrations, scanned documents, mindmaps etc. into the project’s own folder, all the relative links to these resources in the work journals should be converted with respect to the org-roam root directory.","headline":"Migrated project work journals to org-roam root directory","mainEntityOfPage":{"@type":"WebPage","@id":"https://jihuan-tian.github.io/computer/2024/07/19/migrated-project-work-journals-to-org-roam-root-directory.html"},"url":"https://jihuan-tian.github.io/computer/2024/07/19/migrated-project-work-journals-to-org-roam-root-directory.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/font.css">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/css/htmlize-syntax-highlight.css">
  
  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico?">
  <link href="https://fonts.googlefonts.cn/css?family=EB+Garamond" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://jihuan-tian.github.io/feed.xml" title="止于至善" />
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">止于至善</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <!-- Enforce a fixed order for my categories. -->
          <a class="page-link" href="/math/">Math</a>
          <a class="page-link" href="/computer/">Computer</a>
          <a class="page-link" href="/thoughts/">Thoughts</a>
          <a class="page-link" href="/tags/">Tags</a>
          <a class="page-link" href="/search/">Search</a>
          <a class="page-link" href="/about/">About</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Migrated project work journals to org-roam root directory</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-07-19T00:00:00+08:00" itemprop="datePublished">Jul 19, 2024 &nbsp;

        
          Categories:
          
            <a href="/computer">Computer</a>
          
         &nbsp;
        
          Tags:
          
            <a href="/tags/Org-mode">Org-mode</a>
          
        
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><code class="language-plaintext highlighter-rouge">org-roam</code> does not support Org files scattered in different folders which do not share a common ancestor. Therefore, I have to migrate my project work journals to the <code class="language-plaintext highlighter-rouge">org-roam</code> root directory. Since I still prefer to store project resources including figures, illustrations, scanned documents, mindmaps etc. into the project’s own folder, all the relative links to these resources in the work journals should be converted with respect to the <code class="language-plaintext highlighter-rouge">org-roam</code> root directory.</p>

<p>With the help of ChatGPT, I wrote the following Elisp function to achieve the above purpose. Note that this script also works for a link to Org heading like this <code class="language-plaintext highlighter-rouge">[[file:../../file.org::heading text]]</code>.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defun</span> <span class="nv">tjh/is-relative-path</span> <span class="p">(</span><span class="nv">path</span><span class="p">)</span>
  <span class="s">"Check if PATH is a relative path."</span>
  <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">file-name-absolute-p</span> <span class="nv">path</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">tjh/replace-string-in-region</span> <span class="p">(</span><span class="nv">start</span> <span class="nv">end</span> <span class="nv">replacement</span><span class="p">)</span>
  <span class="s">"Replace the string between START and END with REPLACEMENT."</span>
  <span class="p">(</span><span class="nv">goto-char</span> <span class="nv">start</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">delete-region</span> <span class="nv">start</span> <span class="nv">end</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">insert</span> <span class="nv">replacement</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">tjh/org-migrate-relative-links</span> <span class="p">(</span><span class="nv">target-migration-dir</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">interactive</span> <span class="s">"DTarget migration directory: "</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">))</span>
  <span class="c1">;; Search each link in the Org file.</span>
  <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nv">re-search-forward</span> <span class="nv">org-link-bracket-re</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">link-start</span> <span class="p">(</span><span class="nv">match-beginning</span> <span class="mi">0</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">link-end</span> <span class="p">(</span><span class="nv">match-end</span> <span class="mi">0</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">url</span> <span class="p">(</span><span class="nv">match-string-no-properties</span> <span class="mi">1</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">actual-url</span> <span class="nv">url</span><span class="p">)</span>
           <span class="p">(</span><span class="nv">desc</span> <span class="p">(</span><span class="nv">match-string-no-properties</span> <span class="mi">2</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">link</span> <span class="p">(</span><span class="nv">org-element-lineage</span> <span class="p">(</span><span class="nv">org-element-context</span><span class="p">)</span> <span class="o">'</span><span class="p">(</span><span class="nv">link</span><span class="p">)</span> <span class="no">t</span><span class="p">))</span>
           <span class="p">(</span><span class="k">type</span> <span class="p">(</span><span class="nv">org-element-property</span> <span class="ss">:type</span> <span class="nv">link</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">has-run-prefx</span> <span class="no">nil</span><span class="p">))</span>

      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">string=</span> <span class="k">type</span> <span class="s">"file"</span><span class="p">)</span>
          <span class="p">(</span><span class="k">progn</span>
            <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">string-match</span> <span class="s">"^file:run:\\(.*\\)"</span> <span class="nv">url</span><span class="p">)</span>
                <span class="c1">;; Remove the prefix "file:run:"</span>
                <span class="p">(</span><span class="k">progn</span>
                  <span class="p">(</span><span class="k">setq</span> <span class="nv">actual-url</span> <span class="p">(</span><span class="nv">substring</span> <span class="nv">url</span> <span class="mi">9</span><span class="p">))</span>
                  <span class="p">(</span><span class="k">setq</span> <span class="nv">has-run-prefx</span> <span class="no">t</span><span class="p">))</span>
              <span class="c1">;; Remove the prefix "file:"</span>
              <span class="p">(</span><span class="k">setq</span> <span class="nv">actual-url</span> <span class="p">(</span><span class="nv">substring</span> <span class="nv">url</span> <span class="mi">5</span><span class="p">)))</span>

            <span class="c1">;; We only transform relative path.</span>
            <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">tjh/is-relative-path</span> <span class="nv">actual-url</span><span class="p">)</span>
                <span class="p">(</span><span class="k">progn</span>
                  <span class="p">(</span><span class="k">setq</span> <span class="nv">actual-url</span>
                        <span class="p">(</span><span class="nv">file-relative-name</span>
                         <span class="p">(</span><span class="nv">expand-file-name</span> <span class="nv">actual-url</span><span class="p">)</span>
                         <span class="nv">target-migration-dir</span><span class="p">))</span>
                  <span class="c1">;; Prepend the "run:" prefix if needed.</span>
                  <span class="p">(</span><span class="k">if</span> <span class="nv">has-run-prefx</span>
                      <span class="p">(</span><span class="k">setq</span> <span class="nv">actual-url</span> <span class="p">(</span><span class="nv">concat</span> <span class="s">"run:"</span> <span class="nv">actual-url</span><span class="p">)))</span>

                  <span class="p">(</span><span class="k">if</span> <span class="nv">desc</span>
                      <span class="p">(</span><span class="nv">tjh/replace-string-in-region</span>
                       <span class="nv">link-start</span>
                       <span class="nv">link-end</span>
                       <span class="p">(</span><span class="nb">format</span> <span class="s">"[[%s:%s][%s]]"</span> <span class="k">type</span> <span class="nv">actual-url</span> <span class="nv">desc</span><span class="p">))</span>
                    <span class="p">(</span><span class="nv">tjh/replace-string-in-region</span>
                     <span class="nv">link-start</span>
                     <span class="nv">link-end</span>
                     <span class="p">(</span><span class="nb">format</span> <span class="s">"[[%s:%s]]"</span> <span class="k">type</span> <span class="nv">actual-url</span><span class="p">))))))))))</span>
</code></pre></div></div>

<p>After that, I assigned a unique id to each headings in all Org files under a specified directory. As long as a heading has an id, it will be recognized by <code class="language-plaintext highlighter-rouge">org-roam</code> as a piece of independent note.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; Add ids to all headings of the current Org file.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">tjh/org-add-ids-to-all-headings</span> <span class="p">()</span>
  <span class="s">"Add IDs to all headings in the current buffer."</span>
  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">org-map-entries</span> <span class="ss">'org-id-get-create</span><span class="p">))</span>

<span class="c1">;; Add ids to all headings in all Org files under a directory.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">tjh/org-add-ids-to-org-files</span> <span class="p">(</span><span class="nb">directory</span><span class="p">)</span>
  <span class="s">"Add IDs to all headings in all Org files in DIRECTORY."</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">file</span> <span class="p">(</span><span class="nv">directory-files-recursively</span> <span class="nb">directory</span> <span class="s">"\\.org$"</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="p">(</span><span class="nv">find-file-noselect</span> <span class="nv">file</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">tjh/org-add-ids-to-all-headings</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">save-buffer</span><span class="p">))))</span>
</code></pre></div></div>

<p>Before using <code class="language-plaintext highlighter-rouge">org-roam</code>, I inserted internal links between different Org notes via the default mechanism provided by Org <code class="language-plaintext highlighter-rouge">org-store-link</code>. However, if the heading text is changed, all links to it will fail. Now with the above assigned indices, heading text changing will not invalid the links, which is much more robust. Setting the variable <code class="language-plaintext highlighter-rouge">org-id-link-to-org-use-id</code> to <code class="language-plaintext highlighter-rouge">t</code>, calling <code class="language-plaintext highlighter-rouge">org-store-link</code> will generate a id link.</p>

<p>I do not like the Zettelkasten concept. It would produce a lot of scattered small Org files, which are difficult to manage and browse. And they cannot be directly displayed in Org agenda. Therefore, I still put my notes belong to a same category into a same Org file.</p>

<p>The topology among my notes and journals can be visualized via <code class="language-plaintext highlighter-rouge">org-roam-ui</code>.</p>

<p><img src="/figures/2024-07-19-org-roam-all-note-links.png" alt="img" /></p>

<p>Backlinks: <a href="/computer/2024/07/25/export-org-contents-to-latex-file-containing-relative-links.html">《Export Org contents to LaTeX file containing relative links》</a></p>

  </div><script src="https://utteranc.es/client.js"
          repo="jihuan-tian/jihuan-tian.github.io"
          issue-term="pathname"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>

  <a class="u-url" href="/computer/2024/07/19/migrated-project-work-journals-to-org-roam-root-directory.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">止于至善</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jihuan Tian</li><li><a class="u-email" href="mailto:jihuan_tian@hotmail.com">jihuan_tian@hotmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>RSS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>As regards numerical analysis, mathematical electromagnetism, Linux techniques and personal thoughts.</p>
      </div>
      <div class="footer-col">
        <p>The articles are under a <a href='http://creativecommons.org/licenses/by-nc-sa/4.0/'>Creative Commons Attribution License</a>. Copyright &copy; 2025 <a href="mailto:jihuan_tian@hotmail.com">Jihuan Tian</a>.</p>
      </div>
    </div>
  </div>

</footer>
</body>

</html>
